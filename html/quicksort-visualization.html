<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¿«é€Ÿæ’åºå¯è§†åŒ–æ•™å­¦</title>
    <style>
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .array-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: flex-end;
            min-height: 300px;
        }
        .array-item {
            width: 40px;
            min-height: 20px;
            height: calc(var(--value) * 2px);
            background: #4CAF50;
            color: white;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            border-radius: 5px 5px 0 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 2px;
            padding: 5px;
            font-size: 12px;
            transform-origin: bottom;
        }
        .pivot {
            background: #ff9800;
            transform: scale(1.1);
        }
        .compare {
            background: #2196F3;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.5);
        }
        .sorted {
            background: #9C27B0;
        }
        .swapping {
            transform: translateY(-30px);
            z-index: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: #FF5722 !important;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 20px auto;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        #stopBtn {
            background: #f44336;
            color: white;
        }
        #stopBtn:disabled {
            background: #ffcdd2;
            cursor: not-allowed;
        }
        .explanation {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .tutorial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .tutorial-card {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .tutorial-card:hover {
            transform: translateY(-5px);
        }
        .tutorial-card h4 {
            margin: 0 0 10px;
            color: #2c3e50;
        }
        .tutorial-card p {
            color: #7f8c8d;
            line-height: 1.6;
        }
        .start-btn {
            background: #3498db;
            color: white;
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            font-size: 18px;
        }
        .start-btn:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¿«é€Ÿæ’åºç®—æ³•å¯è§†åŒ–</h1>
        <div class="controls">
            <div>
                <label>æ•°ç»„å¤§å°ï¼š</label>
                <input id="arraySize" type="number" min="5" max="20" value="10">
            </div>
            <div>
                <label>æœ€å¤§å€¼ï¼š</label>
                <input id="maxValue" type="number" min="10" max="100" value="50">
            </div>
            <button id="startBtn">å¼€å§‹æ’åº</button>
            <button id="stopBtn" disabled>åœæ­¢</button>
            <button id="newArrayBtn">æ–°æ•°ç»„</button>
        </div>
        <div class="array-container" id="arrayContainer"></div>
        <div class="explanation" id="explanation">
            <div id="tutorial">
                <h3>å¿«é€Ÿæ’åºåŸºç¡€æ¦‚å¿µ</h3>
                <div class="tutorial-grid">
                    <div class="tutorial-card">
                        <h4>ğŸ“Œ åŸºå‡†å€¼ (Pivot)</h4>
                        <p>æ¯æ¬¡é€’å½’é€‰æ‹©çš„ä¸€ä¸ªå…ƒç´ ï¼Œä½œä¸ºæ¯”è¾ƒçš„åŸºå‡†ã€‚é€šå¸¸é€‰æ‹©æœ€åä¸€ä¸ªå…ƒç´ ä½œä¸ºåŸºå‡†å€¼ã€‚</p>
                        <div class="pivot-example" style="color:#e67e22;">ç¤ºä¾‹ï¼šé€‰æ‹©æœ€åä¸€ä¸ªå…ƒç´  [3,1,2,<strong>5</strong>]</div>
                    </div>
                    <div class="tutorial-card">
                        <h4>ğŸ” åˆ†åŒº (Partition)</h4>
                        <p>å°†æ•°ç»„åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šå°äºåŸºå‡†å€¼çš„å…ƒç´  | åŸºå‡†å€¼ | å¤§äºåŸºå‡†å€¼çš„å…ƒç´ </p>
                        <div class="partition-example" style="color:#2ecc71;">ç¤ºä¾‹ç»“æœï¼š[3,1,2] 5 [7,6,8]</div>
                    </div>
                    <div class="tutorial-card">
                        <h4>âš™ï¸ é€’å½’ (Recursion)</h4>
                        <p>å¯¹å·¦å³å­æ•°ç»„é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ éƒ½æ’åºå®Œæˆã€‚</p>
                        <div class="recursion-example" style="color:#9b59b6;">æµç¨‹ï¼šå·¦æ•°ç»„ â†’ åŸºå‡†å€¼ â†’ å³æ•°ç»„</div>
                    </div>
                </div>
                <button onclick="hideTutorial()" class="start-btn">å¼€å§‹æ’åºä½“éªŒ â†’</button>
            </div>
            <div id="stepExplanation" style="display:none;">
                <h3>ç®—æ³•æ­¥éª¤è¯´æ˜ï¼š</h3>
                <p id="stepText">ç‚¹å‡»å¼€å§‹æŒ‰é’®æŸ¥çœ‹æ’åºè¿‡ç¨‹...</p>
            </div>
        </div>
    </div>

    <script>
        let arr = [];
        let delay = 1000;
        let isSorting = false;
        let currentAnimation = null;

        function init() {
            // ç»‘å®šæ§ä»¶äº‹ä»¶
            document.getElementById('startBtn').addEventListener('click', startSorting);
            document.getElementById('stopBtn').addEventListener('click', stopSorting);
            document.getElementById('newArrayBtn').addEventListener('click', createNewArray);
            document.getElementById('arraySize').addEventListener('change', resetArray);
            document.getElementById('maxValue').addEventListener('change', resetArray);
            
            // åˆå§‹åŒ–é»˜è®¤æ•°ç»„
            resetArray();
        }

        function resetArray() {
            const size = parseInt(document.getElementById('arraySize').value);
            const max = parseInt(document.getElementById('maxValue').value);
            arr = Array.from({length: size}, () => Math.floor(Math.random() * max) + 10);
            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('arrayContainer');
            container.innerHTML = '';
            arr.forEach((value, index) => {
                const item = document.createElement('div');
                item.className = 'array-item';
                item.style.height = `${value * 2}px`;
                item.style.setProperty('--value', value);
                item.textContent = value;
                container.appendChild(item);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateStepText(text) {
            document.getElementById('stepText').textContent = text;
        }
        
        // åˆå§‹åŒ–
        init();

        async function startSorting() {
            isSorting = true;
            currentAnimation = null;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            updateStepText('æ’åºè¿›è¡Œä¸­...');
            try {
                await quickSort();
                if (isSorting) {
                    updateStepText('æ’åºå®Œæˆï¼');
                }
            } catch (e) {
                if (e !== 'sort_stopped') {
                    updateStepText('æ’åºå‡ºé”™: ' + e);
                }
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        async function quickSort(start = 0, end = arr.length - 1) {
            if (start >= end || !isSorting) throw 'sort_stopped';
            
            // å…ˆå¤„ç†å·¦å­æ•°ç»„
            const pivotIndex = await partition(start, end);
            if (!isSorting) return;
            
            // æ˜¾å¼ç­‰å¾…å·¦å­æ•°ç»„æ’åºå®Œæˆ
            await quickSort(start, pivotIndex - 1);
            if (!isSorting) return;
            
            // ç„¶åå¤„ç†å³å­æ•°ç»„
            await quickSort(pivotIndex + 1, end);
            
            // æœ€åæ ‡è®°åŸºå‡†å€¼å·²æ’åº
            try {
                if (isSorting) {
                    document.querySelectorAll('.array-item')[pivotIndex].classList.add('sorted');
                    updateStepText(`åŸºå‡†å€¼ ${arr[pivotIndex]} å·²æœ€ç»ˆå®šä½`);
                    await sleep(1000);
                }
            } catch (e) {
                if (e !== 'sort_stopped') throw e;
            }
        }

        async function partition(start, end) {
            const pivotValue = arr[end];
            let pivotIndex = start;
            
            // é«˜äº®æ˜¾ç¤ºåŸºå‡†å€¼
            updateStepText(`é€‰æ‹©åŸºå‡†å€¼ï¼š${pivotValue}ï¼ˆç´¢å¼• ${end}ï¼‰`);
            await highlightElements([end], 'pivot', 1500);

            for (let i = start; i < end; i++) {
                if (!isSorting) throw 'sort_stopped';
                
                // é«˜äº®å½“å‰æ¯”è¾ƒå…ƒç´ 
                await highlightElements([i], 'compare', 800);
                
                if (arr[i] < pivotValue) {
                    if (i !== pivotIndex) {
                        updateStepText(`äº¤æ¢ ${arr[i]}ï¼ˆå°ï¼‰å’Œ ${arr[pivotIndex]}ï¼ˆå¤§ï¼‰`);
                        await swapElements(i, pivotIndex);
                    } else {
                        updateStepText(`${arr[i]} å·²åœ¨æ­£ç¡®ä½ç½®`);
                        await sleep(500);
                    }
                    pivotIndex++;
                } else {
                    updateStepText(`${arr[i]} â‰¥ åŸºå‡†å€¼ï¼Œç»§ç»­æ‰«æ`);
                    await sleep(500);
                }
            }

            // äº¤æ¢åŸºå‡†å€¼åˆ°æœ€ç»ˆä½ç½®
            if (pivotIndex !== end) {
                updateStepText(`å°†åŸºå‡†å€¼ ${pivotValue} ç§»åˆ°æœ€ç»ˆä½ç½® ${pivotIndex}`);
                await swapElements(pivotIndex, end);
            }
            
            return pivotIndex;
        }

        async function highlightElements(indices, className, duration) {
            const items = document.getElementsByClassName('array-item');
            indices.forEach(i => items[i].classList.add(className));
            await sleep(duration/2);
            if (!isSorting) throw 'sort_stopped';
            await sleep(duration/2);
            indices.forEach(i => items[i].classList.remove(className));
        }

        async function swapElements(i, j) {
            if (!isSorting) return;
            
            // åŒæ­¥äº¤æ¢æ•°ç»„å’ŒDOMå…ƒç´ 
            [arr[i], arr[j]] = [arr[j], arr[i]];
            
            // ä½¿ç”¨ä¸´æ—¶å˜é‡ä¿å­˜åŸå§‹å€¼
            let currentItems = document.getElementsByClassName('array-item');
            const tempValue = arr[i];
            
            // äº¤æ¢æ•°ç»„å…ƒç´ 
            [arr[i], arr[j]] = [arr[j], arr[i]];
            
            // ç›´æ¥æ“ä½œDOMå…ƒç´ æ ·å¼å’Œä½ç½®
            currentItems[i].style.transform = `translateX(${(j-i)*50}px)`;
            currentItems[j].style.transform = `translateX(${(i-j)*50}px)`;
            currentItems[i].classList.add('swapping');
            currentItems[j].classList.add('swapping');
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            await Promise.all([
                currentItems[i].getAnimations().forEach(anim => anim.finished),
                currentItems[j].getAnimations().forEach(anim => anim.finished)
            ]);
            
            // é‡ç½®æ ·å¼å¹¶æ›´æ–°DOMé¡ºåº
            currentItems[i].style.transform = '';
            currentItems[j].style.transform = '';
            const parent = currentItems[i].parentNode;
            parent.insertBefore(currentItems[j], currentItems[i]);
            
            // ç›´æ¥æ›´æ–°æ˜¾ç¤ºå†…å®¹
            const updatedItems = document.getElementsByClassName('array-item');
            updatedItems[i].textContent = arr[i];
            updatedItems[i].style.height = `${arr[i]*2}px`;
            updatedItems[j].textContent = arr[j];
            updatedItems[j].style.height = `${arr[j]*2}px`;
            
            // ç§»é™¤åŠ¨ç”»ç±»
            updatedItems[i].classList.remove('swapping');
            updatedItems[j].classList.remove('swapping');
            
            // æ£€æŸ¥æ˜¯å¦ä¸­æ–­
            if (!isSorting) throw 'sort_stopped';
            
            // æœ€ç»ˆçŠ¶æ€åŒæ­¥ï¼ˆå·²é€šè¿‡å‰é¢ä»£ç å®Œæˆï¼‰
        }

        function stopSorting() {
            isSorting = false;
            if (currentAnimation) {
                currentAnimation.catch(() => {});
            }
            updateStepText('æ’åºå·²åœæ­¢');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateDisplay();
        }

        // è¾…åŠ©å‡½æ•°
        function createNewArray() {
            resetArray();
            document.getElementById('startBtn').disabled = false;
            updateStepText('æ–°æ•°ç»„å·²ç”Ÿæˆï¼Œç‚¹å‡»å¼€å§‹æ’åº');
        }

        // æ•™ç¨‹éšè—åŠŸèƒ½
        function hideTutorial() {
            document.getElementById('tutorial').style.display = 'none';
            document.getElementById('stepExplanation').style.display = 'block';
        }
    </script>
</body>
</html>
